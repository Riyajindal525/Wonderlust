<% layout("layouts/boilerplate") %>

<script>
  let mapToken = '<%= process.env.MAP_TOKEN %>';
  const listing = <%- JSON.stringify(listing)%>
</script>



 
<!-- MAIN LISTING CONTAINER -->
<div class="container my-5">
  <h2 class="mb-4 fw-bold text-center"><%= listing.title %></h2>

  <div class="card border-0 mx-auto shadow" style="max-width: 850px;">

    <!-- Listing Image -->
    <% if (listing.image) { %>
      <img src="<%= listing.image.url %>"
           alt="Listing Image"
           class="card-img-top rounded-3"
           style="object-fit: cover; height: 300px; width: 100%;">
    <% } %>

    <!-- Card Body -->
    <div class="card-body px-4">

      <p class="text-muted mb-2">Owned by : <%= listing.owner.username %></p>

      <p class="text-muted mb-2" style="line-height: 1.6;">
        <%= listing.description %>
      </p>

      <p class="fw-bold fs-5 text-success">â‚¹<%= listing.price %></p>

      <p class="mb-0">
        <i class="bi bi-geo-alt-fill text-danger"></i> <%= listing.location %>
      </p>

      <p class="mb-3"><%= listing.country %></p>

      <% if (currentUser && currentUser._id.toString() === listing.owner._id.toString()) { %>
        <div class="d-flex gap-3 mt-3">

          <a href="/listings/<%= listing._id %>/edit"
             class="btn"
             style="background-color: #fea9ae; border: none; border-radius: 6px;">
            <i class="bi bi-pencil-square"></i> Edit
          </a>

          <form action="/listings/<%= listing._id %>?_method=DELETE" method="POST" class="m-0">
            <button class="btn btn-danger px-4"
              style="background-color: rgb(133, 20, 39); border: none; border-radius: 6px;">
              <i class="bi bi-trash"></i> Delete
            </button>
          </form>

        </div>
      <% } %>

    </div>
  </div>
</div>


<h4 class=" text-center  mb-2 mt-2">Where You'l be</h4>

<div class="card border-0 shadow-sm mx-auto" style="max-width: 850px;">
  
  <div class="card-body p-0">
    <div id="map"
         class="rounded-3"
         style="height: 350px; width: 100%; overflow: hidden;">
    </div>
  </div>
</div>
 <br />

<!-- REVIEW FORM -->
<div class="card border-0 shadow-sm mx-auto mt-5" style="max-width: 850px;">
  <div class="card-body">

    <h4 class="fw-bold mb-3">Leave a Review</h4>

    <form action="/listings/<%= listing._id %>/reviews" method="POST" novalidate class="needs-validation">

      <!-- Star Rating -->
      <fieldset class="starability-slot">
        <legend>First rating:</legend>

        <input type="radio" id="no-rate" class="input-no-rate"
               name="review[rating]" value="0" checked aria-label="No rating." />

        <input type="radio" id="second-rate1" name="review[rating]" value="1" />
        <label for="second-rate1" title="Terrible">1 star</label>

        <input type="radio" id="second-rate2" name="review[rating]" value="2" />
        <label for="second-rate2" title="Not good">2 stars</label>

        <input type="radio" id="second-rate3" name="review[rating]" value="3" />
        <label for="second-rate3" title="Average">3 stars</label>

        <input type="radio" id="second-rate4" name="review[rating]" value="4" />
        <label for="second-rate4" title="Very good">4 stars</label>

        <input type="radio" id="second-rate5" name="review[rating]" value="5" />
        <label for="second-rate5" title="Amazing">5 stars</label>
      </fieldset>

      <div class="mb-3">
        <label for="comment" class="form-label fw-semibold">Comment</label>
        <textarea id="comment" name="review[comment]" class="form-control" rows="4" required></textarea>
      </div>

      <% if (!currentUser) { %>
        <p class="text-center mt-2 fw-semibold">
          Please
          <a href="/login" class="text-primary text-decoration-underline">Login</a>
          or
          <a href="/signup" class="text-success text-decoration-underline">Signup</a>
          to submit a review.
        </p>
      <% } %>

      <% if (currentUser) { %>
        <button type="submit" class="btn px-4"
          style="border: none; background-color: #f5eff0;">
          <i class="bi bi-send"></i> Submit Review
        </button>
      <% } %>

    </form>

  </div>
</div>




<!-- SHOW ALL REVIEWS -->
<div class="container my-5" style="max-width: 850px; margin-bottom: 100px;">
  
  <% if (listing.reviews.length !== 0) { %>
  <h4 class="fw-bold mb-4 text-center text-dark">All Reviews</h4>
  <% } %>

  <% if (listing.reviews.length === 0) { %>

    <div class="text-center">
      No reviews yet. Be the first to review this listing!
    </div>

  <% } else { %>

    <div class="row g-4">

      <% listing.reviews.forEach(review => { %>
        <div class="col-md-6">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-body position-relative">

              <div class="d-flex justify-content-between mb-2">
                <p class="starability-result" data-rating="<%= review.rating %>"></p>

                <small class="text-muted">
                  <i class="bi bi-person-circle"></i> &nbsp; @<%= review.author.username %>
                </small>
              </div>

              <p class="mb-4"><%= review.comment %></p>

              <% if (currentUser && currentUser._id.equals(review.author._id)) { %>
                <form action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE"
                      method="POST">
                  <button type="submit" class="btn btn-sm btn-outline-danger rounded-pill px-3 py-1"
                          style="color: black;">
                    <i class="bi bi-trash"></i> Delete
                  </button>
                </form>
              <% } %>

            </div>
          </div>
        </div>
      <% }) %>

    </div>

  <% } %>

</div>




<!-- MAP SCRIPT -->
 <script src ="/js/map.js"></script>


 
  
